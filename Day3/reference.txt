# Day 3: Hybrid Search

## What I Learned Today

### 1. The Big "Aha!" Moment

**Why Hybrid Search Exists:**

Pure Semantic Search:
- âœ“ Understands meaning: "revenue" = "sales" = "income"
- âœ— Might miss exact matches: Query "Q4 2024" finds Q1, Q2, Q3 too

Pure Keyword Search (BM25):
- âœ“ Finds exact matches: "Q4 2024" only returns Q4 2024 docs
- âœ— Misses synonyms: "revenue" doesn't match "sales"

Hybrid Search:
- âœ“âœ“ Gets BOTH!
- âœ“âœ“ Best of both worlds!

### 2. BM25 Algorithm (In My Own Words)

BM25 = "Smart keyword matching"

**How it works:**
1. Splits documents into words (tokenization)
2. Weights rare words higher than common words
   - "Q4" appears in 1/6 docs â†’ High score
   - "campaign" appears in 5/6 docs â†’ Low score
3. Accounts for document length (short docs aren't penalized)

**Formula (simplified):**
```
Score = How rare the word is Ã— How often it appears in doc
```

**Key Insight:**
- BM25 is LOCAL (runs on my computer)
- BM25 is FREE (no API calls)
- BM25 is FAST (no embedding needed)

### 3. The Alpha Parameter (Secret Sauce)

**Formula:**
```python
final_score = (alpha Ã— semantic_score) + ((1 - alpha) Ã— keyword_score)
```

**What different alphas mean:**

| Alpha | Meaning | Use When | Example Query |
|-------|---------|----------|---------------|
| 0.3 | 30% semantic, 70% keyword | Need exact matches | "Q4 2024", "Campaign #123" |
| 0.5 | 50/50 balanced | General purpose | "social media campaigns" |
| 0.7 | 70% semantic, 30% keyword | Conceptual queries | "boost engagement" |

**My Testing Results:**

Query: "Q4 2024 social media"
- Alpha 0.3: Found Q4 2024 doc (keyword won)
- Alpha 0.5: Found Q4 2024 social media doc (balanced)
- Alpha 0.7: Found all social media docs (semantic won)

**Best for CampaignBrain:** alpha = 0.5 (balanced)

### 4. Score Normalization (Important!)

**The Problem:**
- Semantic scores: 0.0 to 1.0 (cosine similarity)
- BM25 scores: 0 to infinity (no upper limit!)

**Can't combine directly:**
```python
# WRONG!
combined = 0.8 (semantic) + 15.3 (BM25) = 16.1
# BM25 dominates unfairly!
```

**Solution: Normalize BM25 to 0-1:**
```python
max_bm25 = 20.0  # highest BM25 score
normalized_bm25 = 15.3 / 20.0 = 0.765

# NOW can combine fairly:
combined = 0.5 Ã— 0.8 + 0.5 Ã— 0.765 = 0.783 âœ“
```

### 5. When to Use What?

**Use SEMANTIC only when:**
- Query is conceptual ("improve conversion rates")
- Synonyms are important
- Don't care about exact terms

**Use KEYWORD only when:**
- Need exact matches (dates, IDs, names)
- Rare technical terms
- Exact phrase matching

**Use HYBRID (MY CHOICE) when:**
- Real-world queries (most common!)
- Mix of concept + exact terms
- Marketing use case: "Facebook ads Q4" = platform + time

### 6. Connection to CampaignBrain

**Why hybrid is PERFECT for marketing agencies:**

Marketing queries are usually mixed:
- "Q4 social media campaigns" = time period + channel + concept
- "Facebook ads that increased conversions" = platform + outcome
- "Email campaigns December 2024" = channel + exact date

Example from my testing:
```
Query: "Facebook campaigns that drove sales"

Semantic finds:
- "Instagram ads boosted revenue" (understands sales = revenue)
- "Social media increased purchases" (understands concept)

Keyword finds:
- "Facebook campaign" docs (exact platform match)

Hybrid combines:
- Top result: "Facebook campaign increased sales" âœ“âœ“
```

---

## Code I Wrote Today

### Files Created:
- âœ… `knowledge/bm25_search.py` - Keyword search (150 lines)
- âœ… `knowledge/hybrid_search.py` - Combined search (250 lines)
- âœ… `learning/day3_comparison_test.py` - Testing (120 lines)

### Key Functions:
1. `BM25Searcher.index()` - Build keyword index
2. `BM25Searcher.search()` - Search with keywords
3. `HybridSearcher.index()` - Index for both methods
4. `HybridSearcher.search()` - Combined search
5. `HybridSearcher.compare_alphas()` - Test different weights

---

## Test Results & Experiments

### Experiment 1: Alpha Comparison

**Query:** "Q4 2024 social media"

| Alpha | Top Result | Why |
|-------|-----------|-----|
| 0.3 | Q4 2024 Facebook campaign | Keyword dominated - found exact "Q4 2024" |
| 0.5 | Q4 2024 social media campaign | Balanced - found both exact date AND concept |
| 0.7 | Social media strategy Dec | Semantic dominated - missed specific "Q4" |

**Conclusion:** Alpha 0.5 gives best results for this query

### Experiment 2: Semantic vs Keyword vs Hybrid

**Query:** "increase sales"

- Semantic: Found "boosted revenue", "grew income" âœ“
- Keyword: Found nothing (no exact "increase sales") âœ—
- Hybrid: Found semantic results + any with "sales" âœ“âœ“

**Winner:** Hybrid (got best of both)


## Wins ðŸŽ‰

- âœ… Hybrid search working perfectly!
- âœ… Understand when to use semantic vs keyword vs both
- âœ… Can tune alpha for different query types
- âœ… Still saving money with caching (90% hit rate now!)
- âœ… Search quality is WAY better than Day 1-2

---

## Struggles & Solutions ðŸ˜…

**Struggle 1:** BM25 scores seemed random at first
- **Solution:** Realized rare words get higher scores - this is GOOD!

**Struggle 2:** Didn't understand why normalize BM25 scores
- **Solution:** Drew it out - can't add scores with different scales

**Struggle 3:** Alpha parameter confused me
- **Solution:** Tested with extreme values (0.1, 0.9) to see effect

---

## Key Metrics

**Technical:**
- Documents indexed: 6 (will add more tomorrow)
- Search methods: 3 (semantic, keyword, hybrid)
- Alpha tested: 0.3, 0.5, 0.7
- Retrieval accuracy: ~85% (informal testing)

**Cost:**
- Embeddings today: $0.05
- BM25: $0 (free!)
- Cache hit rate: 60% (improving!)
- Total Day 3: $0.05

**Time:**
- Learning: 1.5 hours
- Coding: 2.5 hours
- Testing: 1 hour
- Total: 5 hours âœ“

---

## Questions Answered Today

**Q: Why not just use semantic search?**
A: Misses exact matches like dates, IDs, specific names

**Q: Why not just use keyword search?**
A: Misses synonyms and related concepts

**Q: What's the best alpha value?**
A: Depends on query type:
   - Exact queries â†’ 0.3
   - Conceptual â†’ 0.7
   - Most queries â†’ 0.5 (default)

**Q: Is hybrid always better?**
A: Yes for real-world queries! Only exception: if you know query is purely exact match OR purely conceptual


## Cost Tracking (Running Total)

- Day 1: $0.50
- Day 2: $0.05
- Day 3: $0.05
- **Week 1 Total: $0.60** / $3-5 budget âœ“


